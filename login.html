<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secure Auth — Polished</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDKs (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('warn');

    // Global variables for Firebase configuration and state.
    // These are automatically populated in the Canvas environment.
    window.__firebase_config = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
    window.__initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
    window.__app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    try {
      const cfg = JSON.parse(window.__firebase_config || '{}');
      if (Object.keys(cfg).length > 0) {
        window.firebaseApp = initializeApp(cfg);
        window.auth = getAuth(window.firebaseApp);
        window.db = getFirestore(window.firebaseApp);

        onAuthStateChanged(window.auth, (u) => console.debug('auth change', u));

        if (window.__initial_auth_token) {
          signInWithCustomToken(window.auth, window.__initial_auth_token).catch(() => signInAnonymously(window.auth));
        } else {
          signInAnonymously(window.auth).catch(() => {});
        }
      } else {
        console.warn('Firebase config empty — running in demo UI mode.');
      }
    } catch (e) {
      console.warn('Invalid firebase config JSON — demo UI mode.', e);
    }
  </script>

  <style>
    :root {
      --bg-900: #041022;
      --card-bg: rgba(255, 255, 255, 0.02);
      --glass-border: rgba(95, 155, 230, 0.06);
      --accent1: #6B6BFF;
      --accent2: #4DA8DA;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(13, 28, 42, 0.6), transparent 12%),
        linear-gradient(180deg, #03111a 0%, #041522 100%);
      color: #dbe9ff;
      font-family: "Inter", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Particles and orbs */
    #particleCanvas {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      opacity: 0.5;
    }

    .orb {
      position: absolute;
      width: 240px;
      height: 160px;
      border-radius: 50%;
      filter: blur(26px);
      mix-blend-mode: screen;
      z-index: 1;
      pointer-events: none;
      background: radial-gradient(circle at 30% 30%, rgba(77, 168, 218, 0.08), rgba(123, 107, 255, 0.035), transparent 60%);
      animation: floaty 9s ease-in-out infinite;
    }

    .orb.two {
      left: 72%;
      top: 6%;
      animation-duration: 10.8s;
    }

    .orb.one {
      left: 6%;
      top: 14%;
      animation-duration: 8.8s;
    }

    .orb.three {
      left: 44%;
      top: 70%;
      animation-duration: 11s;
    }

    @keyframes floaty {
      0% {
        transform: translateY(-6%) scale(1);
      }
      50% {
        transform: translateY(6%) scale(1.04);
      }
      100% {
        transform: translateY(-6%) scale(1);
      }
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.015));
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      box-shadow: 0 18px 50px rgba(3, 9, 20, 0.65), inset 0 1px 0 rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(8px);
      width: 100%;
      max-width: 480px;
      padding: 2rem;
      position: relative;
      z-index: 2;
    }

    .btn-primary {
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color: #021227;
      font-weight: 700;
      padding: 10px 14px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.06);
      color: #9fb3d6;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.06);
      color: inherit;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }

    .input:focus {
      border-color: rgba(77, 168, 218, 0.5);
      box-shadow: 0 0 0 2px rgba(77, 168, 218, 0.2);
    }

    .pw-bar {
      height: 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.04);
      overflow: hidden;
      margin-top: 6px;
    }
    .pw-fill {
      height: 100%;
      width: 0%;
      transition: width .35s ease;
      background: linear-gradient(90deg, #06b6d4, #7b6bff);
    }

    .panel {
      transition: opacity 0.35s ease, transform 0.4s ease;
      position: relative;
    }
    .panel.hidden {
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
    }

    #formMessage {
      min-height: 1.2rem;
    }

    /* Loader */
    .loader {
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-bottom-color: transparent;
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }
    @keyframes rotation {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>

  <canvas id="particleCanvas"></canvas>
  <div class="orb one" aria-hidden="true"></div>
  <div class="orb two" aria-hidden="true"></div>
  <div class="orb three" aria-hidden="true"></div>

  <div class="card">
    <div class="flex items-center justify-between mb-5">
      <h1 id="authTitle" class="text-lg font-bold">Welcome back</h1>
      <button id="toggleMode" class="btn-ghost">Switch to Signup</button>
    </div>

    <!-- Social logins -->
    <div class="flex gap-3 mb-5">
      <button class="btn-ghost flex-1">Continue with Google</button>
      <button class="btn-ghost flex-1">Continue with GitHub</button>
    </div>

    <div id="formMessage" class="text-center text-sm text-transparent mb-3" aria-live="polite"></div>

    <div class="panel-container relative">
      <!-- LOGIN FORM -->
      <form id="loginPanel" class="panel">
        <div class="space-y-4">
          <label class="block text-sm">
            Email
            <input id="loginEmail" type="email" required class="input mt-1" placeholder="you@domain.com" />
          </label>

          <label class="block text-sm relative">
            Password
            <input id="loginPassword" type="password" required class="input mt-1 pr-10" placeholder="••••••••" />
            <button type="button" id="loginToggle" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-300" aria-label="Show password">
              <!-- eye -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z" stroke="currentColor" stroke-width="1.2"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.2"/></svg>
            </button>
          </label>

          <div class="flex justify-between text-xs text-slate-400">
            <label><input type="checkbox" /> Remember me</label>
            <button type="button" id="forgotBtn" class="text-sky-300">Forgot?</button>
          </div>

          <button id="loginSubmit" type="submit" class="btn-primary mt-3 flex items-center justify-center gap-2">
            Sign in
            <span id="loginSpinner" class="loader hidden"></span>
          </button>
        </div>
      </form>

      <!-- SIGNUP FORM -->
      <form id="signupPanel" class="panel hidden">
        <div class="space-y-4">
          <label class="block text-sm">
            Full name
            <input id="signupName" type="text" class="input mt-1" placeholder="Jane Doe" />
          </label>

          <label class="block text-sm">
            Email
            <input id="signupEmail" type="email" class="input mt-1" placeholder="you@domain.com" />
          </label>

          <label class="block text-sm relative">
            Password
            <input id="signupPassword" type="password" class="input mt-1 pr-10" placeholder="Create password" />
            <button type="button" id="signupToggle" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-300" aria-label="Show password">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z" stroke="currentColor" stroke-width="1.2"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.2"/></svg>
            </button>
            <div class="pw-bar"><div id="pwFill" class="pw-fill"></div></div>
            <div id="pwLabel" class="text-xs text-slate-400 mt-1">Password strength</div>
          </label>

          <label class="block text-sm">
            Confirm password
            <input id="signupConfirm" type="password" class="input mt-1" placeholder="Confirm password" />
          </label>

          <div class="text-xs text-slate-400">By creating an account you agree to our <a href="#" class="text-sky-300">Terms</a>.</div>

          <button id="signupSubmit" type="submit" class="btn-primary mt-3 flex items-center justify-center gap-2">
            Create account
            <span id="signupSpinner" class="loader hidden"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="hidden fixed inset-0 bg-black/60 z-50 grid place-items-center">
    <div class="card p-6">
      <h3 id="modalTitle" class="text-lg font-bold mb-2">Welcome</h3>
      <p id="modalText" class="text-slate-400 mb-3">You are signed in.</p>
      <div class="text-xs text-slate-300 mb-3">
        <div>User ID:</div>
        <div id="modalUid" class="font-mono bg-[#03111a] p-2 rounded mt-2 break-all"></div>
      </div>
      <div class="flex gap-3 justify-end">
        <button id="modalClose" class="btn-ghost">Close</button>
        <button id="modalSignout" class="btn-primary">Sign out</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Utility functions for DOM selection
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // UI elements
    const loginPanel = $('#loginPanel');
    const signupPanel = $('#signupPanel');
    const toggleBtn = $('#toggleMode');
    const authTitle = $('#authTitle');
    const formMessage = $('#formMessage');
    const loginSubmit = $('#loginSubmit');
    const signupSubmit = $('#signupSubmit');
    const loginSpinner = $('#loginSpinner');
    const signupSpinner = $('#signupSpinner');
    const loginEmail = $('#loginEmail');
    const loginPassword = $('#loginPassword');
    const signupEmail = $('#signupEmail');
    const signupPassword = $('#signupPassword');
    const signupConfirm = $('#signupConfirm');
    const pwFill = $('#pwFill');
    const pwLabel = $('#pwLabel');
    const modal = $('#modalBackdrop');
    
    // Firebase objects
    const auth = window.auth || null;
    const db = window.db || null;
    const appId = window.__app_id || 'default-app-id';

    // Toggle login/signup forms
    function toggleForms() {
      const isLogin = !loginPanel.classList.contains('hidden');
      if (isLogin) {
        loginPanel.classList.add('hidden');
        signupPanel.classList.remove('hidden');
        authTitle.textContent = "Create your account";
        toggleBtn.textContent = "Switch to Login";
      } else {
        signupPanel.classList.add('hidden');
        loginPanel.classList.remove('hidden');
        authTitle.textContent = "Welcome back";
        toggleBtn.textContent = "Switch to Signup";
      }
      clearMessage();
    }
    toggleBtn.addEventListener('click', toggleForms);

    // Show/hide password
    $('#loginToggle').addEventListener('click', () => {
      const type = loginPassword.type === 'password' ? 'text' : 'password';
      loginPassword.type = type;
    });
    $('#signupToggle').addEventListener('click', () => {
      const type = signupPassword.type === 'password' ? 'text' : 'password';
      signupPassword.type = type;
    });

    // Password strength check
    function checkPasswordStrength(password) {
      let score = 0;
      if (!password) return {score:0, label:'Too short', pct:0};
      if (password.length >= 8) score++;
      if (/[A-Z]/.test(password)) score++;
      if (/[0-9]/.test(password)) score++;
      if (/[^A-Za-z0-9]/.test(password)) score++;
      const labels = ["Very weak","Weak","Okay","Strong","Very strong"];
      return {score, label: labels[Math.min(score, labels.length - 1)], pct: (score / 4) * 100};
    }
    signupPassword.addEventListener('input', e => {
      const info = checkPasswordStrength(e.target.value);
      pwFill.style.width = info.pct + "%";
      pwLabel.textContent = info.label;
      if (info.score <= 1) pwFill.style.background = 'linear-gradient(90deg,#f97316,#ef4444)';
      else if (info.score === 2) pwFill.style.background = 'linear-gradient(90deg,#f59e0b,#f97316)';
      else if (info.score === 3) pwFill.style.background = 'linear-gradient(90deg,#22c55e,#06b6d4)';
      else pwFill.style.background = 'linear-gradient(90deg,#06b6d4,#7b6bff)';
    });

    // Form message display
    function showMessage(text, type = 'info') {
      formMessage.textContent = text;
      formMessage.classList.remove('text-transparent', 'text-red-400', 'text-emerald-400');
      if (type === 'error') formMessage.classList.add('text-red-400');
      else if (type === 'success') formMessage.classList.add('text-emerald-400');
    }

    function clearMessage() {
      formMessage.textContent = '';
      formMessage.classList.add('text-transparent');
    }
    
    // Set loading state
    function setLoading(button, spinner, on) {
        if (on) {
            button.setAttribute('disabled', 'disabled');
            spinner.classList.remove('hidden');
        } else {
            button.removeAttribute('disabled');
            spinner.classList.add('hidden');
        }
    }

    // Login submit handler
    loginPanel.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMessage();
      setLoading(loginSubmit, loginSpinner, true);
      const email = loginEmail.value.trim();
      const password = loginPassword.value;

      if (!email || !password) {
        showMessage('Email and password are required.', 'error');
        setLoading(loginSubmit, loginSpinner, false);
        return;
      }

      try {
        if (!auth) {
          await new Promise(r => setTimeout(r, 600));
          showMessage('Demo sign-in (Firebase not configured).', 'success');
          showModal("demo-user", "Logged in");
        } else {
          const credential = await signInWithEmailAndPassword(auth, email, password);
          showMessage('Signed in successfully.', 'success');
          showModal(credential.user.uid, "Logged in");
        }
      } catch (err) {
        console.error('Login failed:', err);
        showMessage(err.message || 'Sign-in failed.', 'error');
      } finally {
        setLoading(loginSubmit, loginSpinner, false);
      }
    });

    // Signup submit handler
    signupPanel.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMessage();
      setLoading(signupSubmit, signupSpinner, true);
      const name = $('#signupName').value.trim();
      const email = signupEmail.value.trim();
      const password = signupPassword.value;
      const confirmPassword = signupConfirm.value;

      if (!name || !email || !password || !confirmPassword) {
        showMessage('Please complete all fields.', 'error');
        setLoading(signupSubmit, signupSpinner, false);
        return;
      }
      if (password !== confirmPassword) {
        showMessage('Passwords do not match.', 'error');
        setLoading(signupSubmit, signupSpinner, false);
        return;
      }
      if (checkPasswordStrength(password).score < 2) {
        showMessage('Please choose a stronger password.', 'error');
        setLoading(signupSubmit, signupSpinner, false);
        return;
      }

      try {
        if (!auth) {
          await new Promise(r => setTimeout(r, 700));
          showMessage('Account created successfully (demo).', 'success');
          showModal("demo-" + Date.now(), "Signed up");
        } else {
          const credential = await createUserWithEmailAndPassword(auth, email, password);
          const user = credential.user;
          if (db) {
            const privateCollectionPath = `artifacts/${appId}/users/${user.uid}/profile`;
            await setDoc(doc(db, privateCollectionPath, 'info'), { name, email, createdAt: new Date().toISOString() });
          }
          showMessage('Account created successfully.', 'success');
          showModal(user.uid, "Signed up");
        }
      } catch (err) {
        console.error('Signup failed:', err);
        showMessage(err.message || 'Signup failed.', 'error');
      } finally {
        setLoading(signupSubmit, signupSpinner, false);
      }
    });
    
    // Modal
    function showModal(uid, msg) {
      $('#modalUid').textContent = uid;
      $('#modalText').textContent = msg;
      modal.classList.remove('hidden');
    }
    $('#modalClose').addEventListener('click', () => modal.classList.add('hidden'));
    $('#modalSignout').addEventListener('click', () => modal.classList.add('hidden'));

    // Particle background
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    const particles = [];
    const count = 50;
    function rand(a,b){ return Math.random()*(b-a)+a; }
    class P {
      constructor(){ this.x=rand(0,canvas.width); this.y=rand(0,canvas.height); this.vx=rand(-0.25,0.25); this.vy=rand(-0.15,0.15); this.r=rand(0.8,2.6); this.a=rand(0.04,0.22); this.h=rand(195,215); }
      step(){ this.x+=this.vx; this.y+=this.vy; if (this.x<-20) this.x=canvas.width+20; if (this.x>canvas.width+20) this.x=-20; if (this.y<-20) this.y=canvas.height+20; if (this.y>canvas.height+20) this.y=-20; }
      draw(){ ctx.beginPath(); ctx.fillStyle = `hsla(${this.h},70%,60%,${this.a})`; ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.fill(); }
    }
    function init(){ particles.length=0; for(let i=0;i<count;i++) particles.push(new P()); }
    function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; init(); }
    resize(); addEventListener('resize',resize);

    function loop(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = 'rgba(3,9,20,0.04)'; ctx.fillRect(0,0,canvas.width,canvas.height);
      particles.forEach(p=>{ p.step(); p.draw(); });
      requestAnimationFrame(loop);
    }
    loop();
  </script>

</body>
</html>
